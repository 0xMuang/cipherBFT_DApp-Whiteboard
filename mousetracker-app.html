<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ±Ô∏è Onchain Mouse Tracker - CipherBFT L1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        
        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        /* Ïª§ÏÑú Ïä§ÌÉÄÏùº */
        .cursor {
            position: absolute;
            pointer-events: none;
            transition: left 0.03s linear, top 0.03s linear;
            z-index: 100;
        }
        
        .cursor-pointer {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid var(--cursor-color, #00ff88);
            transform: rotate(-45deg);
            filter: drop-shadow(0 0 6px var(--cursor-color, #00ff88));
        }
        
        .cursor-label {
            position: absolute;
            left: 20px;
            top: 12px;
            background: var(--cursor-color, #00ff88);
            color: #000;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        /* ÏÉÅÌÉú Ìå®ÎÑê */
        #status-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 320px;
            z-index: 1000;
        }
        
        #status-panel h1 {
            font-size: 20px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #status-panel .subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .status-label {
            color: #888;
        }
        
        .status-value {
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        
        .status-value.connected {
            color: #00ff88;
        }
        
        .status-value.disconnected {
            color: #ff6b6b;
        }
        
        .status-value.pending {
            color: #ffd93d;
        }
        
        /* TX Ïπ¥Ïö¥ÌÑ∞ */
        #tx-counter {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tx-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .tx-stat .status-value {
            color: #00ff88;
        }
        
        /* Ïú†Ï†Ä Î¶¨Ïä§Ìä∏ */
        #user-list {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 220px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        #user-list h2 {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }
        
        .user-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #aaa;
        }
        
        /* Î≤ÑÌäº Í≥µÌÜµ */
        .btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }
        
        .btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        }
        
        /* Ïó∞Í≤∞ ÏòÅÏó≠ */
        #connect-area {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        
        /* Î°úÍ∑∏ */
        #event-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 380px;
            max-height: 180px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 1000;
        }
        
        #event-log h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .log-entry {
            color: #888;
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .log-entry.tx {
            color: #00ff88;
        }
        
        .log-entry.event {
            color: #00ccff;
        }
        
        .log-entry.error {
            color: #ff6b6b;
        }
        
        .log-entry.info {
            color: #ffd93d;
        }
        
        /* Í∑∏Î¶¨Îìú Î∞∞Í≤Ω */
        #grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }
        
        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 500px;
            width: 90%;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #00ff88;
        }
        
        .modal p {
            color: #aaa;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .modal input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .modal input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .modal .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå ÌëúÏãú */
        #contract-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        #contract-info .contract-address {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #00ccff;
            word-break: break-all;
        }
        
        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="grid-bg"></div>
    <div id="canvas-container"></div>
    
    <!-- ÏÉÅÌÉú Ìå®ÎÑê -->
    <div id="status-panel">
        <h1>üñ±Ô∏è Onchain Mouse Tracker</h1>
        <div class="subtitle">Real-time cursor sharing on blockchain</div>
        
        <div class="status-row">
            <span class="status-label">Network</span>
            <span class="status-value">CipherBFT L1</span>
        </div>
        <div class="status-row">
            <span class="status-label">Chain ID</span>
            <span class="status-value">85300</span>
        </div>
        <div class="status-row">
            <span class="status-label">Status</span>
            <span class="status-value disconnected" id="connection-status">Not Connected</span>
        </div>
        <div class="status-row">
            <span class="status-label">My Address</span>
            <span class="status-value" id="my-address">-</span>
        </div>
        <div class="status-row">
            <span class="status-label">My Position</span>
            <span class="status-value" id="my-position">-</span>
        </div>
        
        <div id="tx-counter">
            <div class="tx-stat">
                <span class="status-label">üì§ TX Sent</span>
                <span class="status-value" id="tx-sent">0</span>
            </div>
            <div class="tx-stat">
                <span class="status-label">üì• Events Received</span>
                <span class="status-value" id="events-received">0</span>
            </div>
            <div class="tx-stat">
                <span class="status-label">‚ö° Avg Latency</span>
                <span class="status-value" id="avg-latency">-</span>
            </div>
        </div>
        
        <div id="contract-info" style="display: none;">
            <div class="status-row">
                <span class="status-label">Contract</span>
            </div>
            <div class="contract-address" id="contract-address">-</div>
        </div>
    </div>
    
    <!-- Ïú†Ï†Ä Î¶¨Ïä§Ìä∏ -->
    <div id="user-list">
        <h2>üë• Active Users (<span id="user-count">0</span>)</h2>
        <div id="users"></div>
    </div>
    
    <!-- Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ -->
    <div id="event-log">
        <h3>üìã Event Log</h3>
        <div id="log-content"></div>
    </div>
    
    <!-- Ïó∞Í≤∞ Î≤ÑÌäºÎì§ -->
    <div id="connect-area">
        <button class="btn" id="connect-btn">üîó Connect Wallet</button>
        <button class="btn secondary" id="deploy-btn" disabled>üöÄ Deploy Contract</button>
        <button class="btn secondary" id="join-btn" disabled>‚ú® Join Room</button>
    </div>

    <!-- Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå ÏûÖÎ†• Î™®Îã¨ -->
    <div class="modal" id="contract-modal">
        <div class="modal-content">
            <h2>üìù Contract Address</h2>
            <p>Í∏∞Ï°¥ Ïª®Ìä∏ÎûôÌä∏Ïóê Ï∞∏Í∞ÄÌïòÍ±∞ÎÇò, ÏÉàÎ°ú Î∞∞Ìè¨ÌïòÏÑ∏Ïöî.</p>
            <input type="text" id="contract-input" placeholder="0x... (Í∏∞Ï°¥ Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå ÏûÖÎ†•)">
            <div class="btn-group">
                <button class="btn secondary" id="use-existing-btn">Use Existing</button>
                <button class="btn" id="deploy-new-btn">Deploy New</button>
            </div>
        </div>
    </div>

    <!-- ethers.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <script>
        // ===== ÏÑ§Ï†ï =====
        const CONFIG = {
            // Î°úÏª¨ ÌÖåÏä§Ìä∏Ïö© (Anvil)
            chainId: 31337,
            chainName: 'Anvil Local',
            rpcUrl: 'http://localhost:8545',
            // Ïã§Ï†ú Î∞∞Ìè¨Ïãú ÏïÑÎûòÎ°ú Î≥ÄÍ≤Ω
            // chainId: 85300,
            // chainName: 'CipherBFT L1',
            // rpcUrl: 'https://rpc.cipherbft.xyz/',
            nativeCurrency: {
                name: 'ETH',
                symbol: 'ETH',
                decimals: 18
            },
            
            // ÎßàÏö∞Ïä§ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÑÍ≤© (ms)
            updateInterval: 100,
            
            // ÏÉâÏÉÅ ÌåîÎ†àÌä∏
            colors: [
                '#00ff88', '#ff6b6b', '#4ecdc4', '#ffe66d', 
                '#95e1d3', '#f38181', '#aa96da', '#fcbad3',
                '#a8d8ea', '#ff9a3c', '#55efc4', '#fd79a8'
            ]
        };
        
        // Ïª®Ìä∏ÎûôÌä∏ Î∞îÏù¥Ìä∏ÏΩîÎìú & ABI
        const CONTRACT_BYTECODE = "0x608060405234801561001057600080fd5b50610c9a806100206000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063a87430ba11610066578063a87430ba14610135578063b688a36314610168578063d0def52114610180578063e9fad8ee14610193578063f4e0d9ac1461019b57600080fd5b80631465b923146100985780633ccfd60b146100ca5780635b4b6e23146100d257806379b3c69214610108575b600080fd5b6100ab6100a63660046109a9565b6101ae565b604080519315158452602084019290925290820152606001604051809150f35b6100d2610268565b005b6100f56100e0366004610a08565b60006020819052908152604090205460ff1681565b6040519015158152602001604051809150f35b6101206101163660046109a9565b60015481526020019056fd5b60405190151581526020015b60405180910390f35b610148610143366004610a08565b610367565b60405161012c949392919061046b9594939291906104bd565b610170610430565b60405161012c929190610a3b565b6100d261018e366004610ab6565b610495565b6100d2610676565b6100d26101a9366004610b62565b610797565b6001600160a01b038116600090815260208190526040812054819081908190819060ff166101f65750600093508392508291508190506102610565b6001600160a01b0386166000908152602081905260409020600181015460029091015461ffff80821692620100009092041690600190610256565b9450945094509450945094509091929394565b3360009081526020819052604090205460ff166102985760405162461bcd60e51b815260040161028f90610b9f565b60405180910390fd5b336000908152602081905260408120805460ff19168155600181018290556002015560015b60015481101561032d57336001600160a01b0316600182815481106102e4576102e4610bc6565b6000918252602090912001546001600160a01b03160361031b5760018054610310919060001990610bf2565b600182815561032d565b8061032581610c05565b9150506102bd565b5060405133907f7e2e7e4c5765c7e41e8544f25c3f13f911897ed8c43c7866d9c102a7db2f33c690600090a2565b6001600160a01b0381166000908152602081905260408120805460018201546002830154919260ff909116919061ffff80831692620100009004169085906103ae8261085a565b905091939550919395565b60018181548110610100576000905600610c1e565b6000546001600160a01b031633146104195760405162461bcd60e51b815260040161028f90610b9f565b336000908152602081905260409020805460ff191660011790553360018054610430929190610c1e565b60008054610456906001600160a01b031661085a565b905090565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261048257600080fd5b813567ffffffffffffffff8082111561049d5761049d61046b565b604051601f8301601f19908116603f011681019082821181831017156104c5576104c561046b565b816040528381528660208588010111156104de57600080fd5b836020870160208301376000602085830101528094505050505092915050565b60006020828403121561051057600080fd5b813567ffffffffffffffff81111561052757600080fd5b61053384828501610471565b949350505050565b3360009081526020819052604090205460ff166105835760405162461bcd60e51b815260040161028f90610b9f565b6001805480820182556000919091527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b0319163317905560405133907f7e2e7e4c5765c7e41e8544f25c3f13f911897ed8c43c7866d9c102a7db2f33c6906105f89085908590610c69565b60405180910390a25050565b3360009081526020819052604090205460ff166106335760405162461bcd60e51b815260040161028f90610b9f565b336000818152602081905260409020600101805461ffff191661ffff8516179055620100008304600290910155907fa706cc00dcc0a29bd9ae30e7a7e78c8bb63a3f39e80d2793e21df30963c37e4890849084904290610693908290610c85565b60405180910390a25050565b3360009081526020819052604090205460ff16156106ef5760405162461bcd60e51b815260206004820152600d60248201526c105b1c9958591e4818d85b9959609a1b604482015260640161028f565b6040805160806020601f850181900402820181019092528281529091839183918390819084018382808284376000920191909152505050506001805480820182556000919091527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b03191633179055336000818152602081905260409020805460ff1916600117905590507f7e2e7e4c5765c7e41e8544f25c3f13f911897ed8c43c7866d9c102a7db2f33c68383604051610798929190610c69565b60405180910390a25050565b3360009081526020819052604090205460ff166107d35760405162461bcd60e51b815260040161028f90610b9f565b336000818152602081905260409020600181015461ffff908116620100009092041690610856565b604080519182526020820185905281019190915260600160405180910390a25050565b600060018281548110610835576108356109df565b6000918252602090912001546001600160a01b031692915050565b6000806040838503121561086357600080fd5b82359150602083013567ffffffffffffffff81111561088157600080fd5b61088d85828601610471565b9150509250929050565b6000602082840312156108a957600080fd5b5035919050565b80356001600160a01b03811681146108c757600080fd5b919050565b6000602082840312156108de57600080fd5b6108e7826108b0565b9392505050565b60005b838110156109095781810151838201526020016108f1565b50506000910152565b6000815180845261092a8160208601602086016108ee565b601f01601f19169290920160200192915050565b60018060a01b038616815284602082015283604082015260806060820152600061096b6080830184866109c4565b979650505050505050565b6001600160a01b03949094168452602084019290925261ffff166040830152606082015260800190565b6000602082840312156109b257600080fd5b6108e7826108b0565b6020815260006108e76020830184610912565b634e487b7160e01b600052603260045260246000fd5b60008060408385031215610a0657600080fd5b610a0f836108b0565b9150602083013561ffff81168114610a2657600080fd5b809150509250929050565b803561ffff811681146108c757600080fd5b60008060408385031215610a5657600080fd5b610a5f83610a31565b9150610a6d60208401610a31565b90509250929050565b600181811c90821680610a8a57607f821691505b602082108103610aaa57634e487b7160e01b600052602260045260246000fd5b50919050565b600060208284031215610ac257600080fd5b813567ffffffffffffffff811115610ad957600080fd5b82016080818503121561088157600080fd5b634e487b7160e01b600052601160045260246000fd5b81810381811115610b1457610b14610aeb565b92915050565b600060018201610b2c57610b2c610aeb565b5060010190565b60008151610b458185602086016108ee565b9290920192915050565b600061053360f01b8252610b676002830185610b33565b61016160f51b8152600101949350505050565b6000610b868285610b33565b601760f91b81526001019150610b338284610b33565b600060208284031215610bae57600080fd5b5051919050565b6020808252600a908201526927379034b7b4b732b21760b11b604082015260600190565b634e487b7160e01b600052603160045260246000fd5b80820180821115610b1457610b14610aeb565b600060ff821660ff8103610c1857610c18610aeb565b60010192915050565b600081610c3057610c30610aeb565b506000190190565b60008251610c4a8184602087016108ee565b9190910192915050565b634e487b7160e01b600052601260045260246000fd5b604081526000610c7d6040830185610912565b905082602083015292915050565b9283526020830191909152604082015260600190565b610cb860208201836108b056fea26469706673582212208f5a5e5e5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5f64736f6c634300081300330000000000000000000000000000000000000000000000000000000000000000";
        
        const CONTRACT_ABI = [
            "function join(string nickname) external",
            "function moveCursor(uint16 x, uint16 y) external",
            "function leave() external",
            "function getActiveUsers() view returns (address[])",
            "function getUserInfo(address user) view returns (string nickname, uint16 x, uint16 y, bool isActive)",
            "function getActiveUserCount() view returns (uint256)",
            "event CursorMoved(address indexed user, uint16 x, uint16 y, uint256 timestamp)",
            "event UserJoined(address indexed user, string nickname)",
            "event UserLeft(address indexed user)"
        ];
        
        // Í∞ÑÎã®Ìïú Ïª®Ìä∏ÎûôÌä∏ (Ïù∏ÎùºÏù∏ Î∞∞Ìè¨Ïö©)
        const SIMPLE_CONTRACT_SOURCE = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

contract MouseTracker {
    event CursorMoved(address indexed user, uint16 x, uint16 y, uint256 timestamp);
    event UserJoined(address indexed user, string nickname);
    event UserLeft(address indexed user);
    
    struct User {
        string nickname;
        uint16 lastX;
        uint16 lastY;
        bool isActive;
    }
    
    mapping(address => User) public users;
    address[] public activeUsers;
    
    function join(string calldata nickname) external {
        require(!users[msg.sender].isActive, "Already joined");
        users[msg.sender] = User(nickname, 0, 0, true);
        activeUsers.push(msg.sender);
        emit UserJoined(msg.sender, nickname);
    }
    
    function moveCursor(uint16 x, uint16 y) external {
        require(users[msg.sender].isActive, "Not joined");
        users[msg.sender].lastX = x;
        users[msg.sender].lastY = y;
        emit CursorMoved(msg.sender, x, y, block.timestamp);
    }
    
    function leave() external {
        require(users[msg.sender].isActive, "Not joined");
        users[msg.sender].isActive = false;
        for (uint i = 0; i < activeUsers.length; i++) {
            if (activeUsers[i] == msg.sender) {
                activeUsers[i] = activeUsers[activeUsers.length - 1];
                activeUsers.pop();
                break;
            }
        }
        emit UserLeft(msg.sender);
    }
    
    function getActiveUsers() external view returns (address[] memory) {
        return activeUsers;
    }
    
    function getActiveUserCount() external view returns (uint256) {
        return activeUsers.length;
    }
    
    function getUserInfo(address user) external view returns (string memory, uint16, uint16, bool) {
        User memory u = users[user];
        return (u.nickname, u.lastX, u.lastY, u.isActive);
    }
}`;

        // ===== ÏÉÅÌÉú =====
        let provider = null;
        let signer = null;
        let contract = null;
        let contractAddress = null;
        let myAddress = null;
        let isJoined = false;

        // ÏÑ∏ÏÖò ÌÇ§ (ÏûêÎèô ÏÑúÎ™ÖÏö©)
        let sessionWallet = null;
        let sessionContract = null;
        
        const cursors = new Map();
        let lastSentPosition = { x: 0, y: 0 };
        let pendingPosition = null;
        let updateTimer = null;
        let pollTimer = null;
        
        let stats = {
            txSent: 0,
            eventsReceived: 0,
            latencies: [],
            lastTxTime: 0
        };
        
        // ===== DOM ÏöîÏÜå =====
        const canvasContainer = document.getElementById('canvas-container');
        const connectBtn = document.getElementById('connect-btn');
        const deployBtn = document.getElementById('deploy-btn');
        const joinBtn = document.getElementById('join-btn');
        const connectionStatus = document.getElementById('connection-status');
        const myAddressEl = document.getElementById('my-address');
        const myPositionEl = document.getElementById('my-position');
        const txSentEl = document.getElementById('tx-sent');
        const eventsReceivedEl = document.getElementById('events-received');
        const avgLatencyEl = document.getElementById('avg-latency');
        const usersEl = document.getElementById('users');
        const userCountEl = document.getElementById('user-count');
        const logContent = document.getElementById('log-content');
        const contractModal = document.getElementById('contract-modal');
        const contractInput = document.getElementById('contract-input');
        const contractAddressEl = document.getElementById('contract-address');
        const contractInfoEl = document.getElementById('contract-info');
        
        // ===== Î°úÍπÖ =====
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
            
            while (logContent.children.length > 100) {
                logContent.removeChild(logContent.firstChild);
            }
            
            console.log(`[${type}] ${message}`);
        }
        
        // ===== Ïª§ÏÑú Í¥ÄÎ¶¨ =====
        function getColorForAddress(address) {
            const index = parseInt(address.slice(-4), 16) % CONFIG.colors.length;
            return CONFIG.colors[index];
        }
        
        function createCursor(address, nickname) {
            if (cursors.has(address.toLowerCase())) return;
            
            const color = getColorForAddress(address);
            
            const cursor = document.createElement('div');
            cursor.className = 'cursor';
            cursor.style.setProperty('--cursor-color', color);
            cursor.innerHTML = `
                <div class="cursor-pointer"></div>
                <div class="cursor-label">${nickname}</div>
            `;
            
            canvasContainer.appendChild(cursor);
            cursors.set(address.toLowerCase(), { element: cursor, nickname, color });
            
            updateUserList();
        }
        
        function updateCursor(address, x, y) {
            const cursor = cursors.get(address.toLowerCase());
            if (!cursor) return;
            
            const screenX = (x / 65535) * window.innerWidth;
            const screenY = (y / 65535) * window.innerHeight;
            
            cursor.element.style.left = `${screenX}px`;
            cursor.element.style.top = `${screenY}px`;
        }
        
        function removeCursor(address) {
            const cursor = cursors.get(address.toLowerCase());
            if (cursor) {
                cursor.element.remove();
                cursors.delete(address.toLowerCase());
                updateUserList();
            }
        }
        
        function updateUserList() {
            usersEl.innerHTML = '';
            userCountEl.textContent = cursors.size;
            
            cursors.forEach((cursor, address) => {
                const isMe = address.toLowerCase() === myAddress?.toLowerCase();
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-dot" style="background: ${cursor.color}; color: ${cursor.color}"></div>
                    <div>
                        <div>${cursor.nickname} ${isMe ? '(me)' : ''}</div>
                        <div class="user-address">${address.slice(0, 6)}...${address.slice(-4)}</div>
                    </div>
                `;
                usersEl.appendChild(item);
            });
        }
        
        function updateStats() {
            txSentEl.textContent = stats.txSent;
            eventsReceivedEl.textContent = stats.eventsReceived;
            
            if (stats.latencies.length > 0) {
                const recent = stats.latencies.slice(-10);
                const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
                avgLatencyEl.textContent = `${avg.toFixed(0)}ms`;
            }
        }
        
        // ===== ÎÑ§Ìä∏ÏõåÌÅ¨ Ï∂îÍ∞Ä =====
        async function addNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: `0x${CONFIG.chainId.toString(16)}`,
                        chainName: CONFIG.chainName,
                        rpcUrls: [CONFIG.rpcUrl],
                        nativeCurrency: CONFIG.nativeCurrency
                    }]
                });
                return true;
            } catch (error) {
                log(`Network add failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // ===== ÏßÄÍ∞ë Ïó∞Í≤∞ =====
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('MetaMaskÎ•º ÏÑ§ÏπòÌï¥Ï£ºÏÑ∏Ïöî!');
                    return;
                }
                
                log('Connecting wallet...', 'info');
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="spinner"></span> Connecting...';
                
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ÑÌôò ÏãúÎèÑ
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: `0x${CONFIG.chainId.toString(16)}` }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await addNetwork();
                    } else {
                        throw switchError;
                    }
                }
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                signer = provider.getSigner();
                myAddress = await signer.getAddress();
                
                const balance = await provider.getBalance(myAddress);
                const balanceEth = ethers.utils.formatEther(balance);
                
                log(`Connected: ${myAddress.slice(0, 8)}...`, 'tx');
                log(`Balance: ${parseFloat(balanceEth).toFixed(4)} ETH`, 'info');
                
                myAddressEl.textContent = `${myAddress.slice(0, 6)}...${myAddress.slice(-4)}`;
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-value connected';
                
                connectBtn.textContent = '‚úÖ Connected';
                deployBtn.disabled = false;
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå Î≥µÏõê
                const savedContract = localStorage.getItem('mouseTrackerContract');
                if (savedContract) {
                    contractInput.value = savedContract;
                    log(`Found saved contract: ${savedContract.slice(0, 10)}...`, 'info');
                }
                
            } catch (error) {
                log(`Connection error: ${error.message}`, 'error');
                connectBtn.disabled = false;
                connectBtn.textContent = 'üîó Connect Wallet';
            }
        }
        
        // ===== Ïª®Ìä∏ÎûôÌä∏ Î∞∞Ìè¨ =====
        async function deployContract() {
            try {
                log('Deploying contract...', 'info');
                deployBtn.disabled = true;
                deployBtn.innerHTML = '<span class="spinner"></span> Deploying...';
                
                const factory = new ethers.ContractFactory(
                    CONTRACT_ABI,
                    "0x608060405234801561001057600080fd5b50610b4a806100206000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063a87430ba1161005b578063a87430ba14610111578063b688a36314610144578063d0def5211461015c578063e9fad8ee1461016f57600080fd5b80631465b9231461008d5780633ccfd60b146100bf5780635b4b6e23146100c957806379b3c69214610103575b600080fd5b6100a061009b3660046108a3565b610177565b604080519315158452602084019290925290820152606001604051809150f35b6100c761022e565b005b6100f36100d73660046108d8565b6001600160a01b031660009081526020819052604090205460ff1690565b6040519015158152602001604051809150f35b6100c76101113660046108a3565b50565b61012461011f3660046108a3565b610313565b604080519485526020850193909352918301521515606082015260800161012c565b61014c6103a5565b60405161012c929190610934565b6100c761016a366004610996565b6103fb565b6100c76105ba565b6001600160a01b03811660009081526020819052604081205481908190819060ff166101bc575060009350600092508291508190506102275600915050565b6001600160a01b03861660009081526020819052604090206001810154600290910154909461ffff808216955062010000909104169250600190506102275655565b9193509193565b3360009081526020819052604090205460ff1661025e5760405162461bcd60e51b815260040161025590610a03565b60405180910390fd5b336000908152602081905260408120805460ff19168155600181018290556002015560015b6001548110156102f357336001600160a01b0316600182815481106102aa576102aa610a2a565b6000918252602090912001546001600160a01b0316036102e15760018054610100919060001990610a56565b60018281556102f3565b806102eb81610a69565b915050610283565b5060405133907f7e2e7e4c5765c7e41e8544f25c3f13f911897ed8c43c7866d9c102a7db2f33c690600090a2565b60008060008061032286610735565b6001600160a01b03871660009081526020819052604090206001810154600290910154909761ffff808216985062010000909104169550600194509092509050565b6060600180548060200260200160405190810160405280929190818152602001828054801561029b57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116103df5750505050509050919050565b3360009081526020819052604090205460ff161561044b5760405162461bcd60e51b815260206004820152600d60248201526c105b1c9958591e4818d85b9959609a1b6044820152606401610255565b60408051608081018252600181526000602080830182815283850183815260608501848152338552928490529490922092518354901515600160a01b0260ff60a01b19919091166001600160a01b039091161783559051928201929092555160029091015560018054808201825560009190915233907fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b0319166001600160a01b039283161790556040517ff6c4a6dc54dfe379be82d587afbaf31514fcdae5a6e7319c2fe7d3c75c9a2f9c91906105ae9085908590610a82565b60405180910390a25050565b3360009081526020819052604090205460ff166105e95760405162461bcd60e51b815260040161025590610a03565b336000818152602081905260409020600101805461ffff191661ffff851617905562010000830460029091015507fa706cc00dcc0a29bd9ae30e7a7e78c8bb63a3f39e80d2793e21df30963c37e4890338484426040516106509493929190610abe565b60405180910390a15050565b6000546001600160a01b0316331461068d5760405162461bcd60e51b815260040161025590610a03565b336000908152602081905260409020805460ff19166001179055336001805480820182556000919091527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b0319166001600160a01b0392909216919091179055565b6000600182815481106106f6576106f6610a2a565b6000918252602090912001546001600160a01b031692915050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261073857600080fd5b813567ffffffffffffffff8082111561075357610753610711565b604051601f8301601f19908116603f0116810190828211818310171561077b5761077b610711565b8160405283815286602085880101111561079457600080fd5b836020870160208301376000602085830101528094505050505092915050565b80356001600160a01b03811681146107cb57600080fd5b919050565b803561ffff811681146107cb57600080fd5b600080604083850312156107f557600080fd5b6107fe836107d0565b915061080c602084016107d0565b90509250929050565b60008060006060848603121561082a57600080fd5b610833846107b4565b92506108416020850161ffff169052565b915061084f604085016107d0565b90509250925092565b60006020828403121561086a57600080fd5b61087382610b4565b9392505050565b60005b8381101561089557818101518382015260200161087d565b50506000910152565b600082601f8301126108af57600080fd5b81516108bd6108b882610b27565b610711565b8181528460208386010111156108d257600080fd5b610533826020830160208701610b7a565b6000602082840312156108f557600080fd5b610873826107b4565b6000815180845261091681602086016020860161087a565b601f01601f19169290920160200192915050565b604081526000610943604083018561089e565b905082602083015292915050565b6000806040838503121561096457600080fd5b823567ffffffffffffffff81111561097b57600080fd5b61098785828601610727565b925050602083013590509250929050565b6000602082840312156109a857600080fd5b813567ffffffffffffffff8111156109bf57600080fd5b6109cb84828501610727565b949350505050565b6000602082840312156109e557600080fd5b5035919050565b6020815260006108736020830184610898565b6020808252600a908201526927379034b7b4b732b21760b11b604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b81810381811115610a6957610a69610a40565b92915050565b600060018201610a8157610a81610a40565b5060010190565b604081526000610a9b60408301856108fe565b9050826020830152929150505056fea264697066735822122082746d0967a5c8e4e5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a5a564736f6c63430008130033",
                    signer
                );
                
                const contractInstance = await factory.deploy();
                log(`TX Hash: ${contractInstance.deployTransaction.hash}`, 'tx');
                
                await contractInstance.deployed();
                contractAddress = contractInstance.address;
                
                log(`‚úÖ Contract deployed: ${contractAddress}`, 'tx');
                
                localStorage.setItem('mouseTrackerContract', contractAddress);
                
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                
                contractAddressEl.textContent = contractAddress;
                contractInfoEl.style.display = 'block';
                
                deployBtn.textContent = '‚úÖ Deployed';
                joinBtn.disabled = false;
                
            } catch (error) {
                log(`Deploy error: ${error.message}`, 'error');
                deployBtn.disabled = false;
                deployBtn.textContent = 'üöÄ Deploy Contract';
            }
        }
        
        // ===== Í∏∞Ï°¥ Ïª®Ìä∏ÎûôÌä∏ ÏÇ¨Ïö© =====
        async function useExistingContract(address) {
            try {
                contractAddress = address;
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                
                // Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
                const count = await contract.getActiveUserCount();
                log(`Connected to contract with ${count} active users`, 'info');
                
                localStorage.setItem('mouseTrackerContract', contractAddress);
                
                contractAddressEl.textContent = contractAddress;
                contractInfoEl.style.display = 'block';
                
                deployBtn.textContent = '‚úÖ Contract Set';
                joinBtn.disabled = false;
                
                contractModal.classList.remove('active');
                
            } catch (error) {
                log(`Invalid contract: ${error.message}`, 'error');
            }
        }
        
        // ===== ÏÑ∏ÏÖò Ï∞∏Í∞Ä =====
        async function joinSession() {
            try {
                joinBtn.disabled = true;
                joinBtn.innerHTML = '<span class="spinner"></span> Setting up...';

                // 1. ÏÑ∏ÏÖò ÏõîÎ†õ ÏÉùÏÑ± (ÏûêÎèô ÏÑúÎ™ÖÏö©)
                sessionWallet = ethers.Wallet.createRandom().connect(provider);
                log(`Session wallet: ${sessionWallet.address.slice(0, 10)}...`, 'info');

                // 2. Î©îÏù∏ ÏßÄÍ∞ëÏóêÏÑú ÏÑ∏ÏÖò ÏõîÎ†õÏúºÎ°ú ETH Ï†ÑÏÜ° (Í∞ÄÏä§ÎπÑÏö©)
                log('Funding session wallet...', 'info');
                const fundTx = await signer.sendTransaction({
                    to: sessionWallet.address,
                    value: ethers.utils.parseEther('0.1') // 0.1 ETH
                });
                await fundTx.wait();
                log('Session wallet funded!', 'tx');

                // 3. ÏÑ∏ÏÖò ÏõîÎ†õÏö© Ïª®Ìä∏ÎûôÌä∏ Ïù∏Ïä§ÌÑ¥Ïä§
                sessionContract = new ethers.Contract(contractAddress, CONTRACT_ABI, sessionWallet);

                // 4. ÏÑ∏ÏÖò ÏõîÎ†õÏúºÎ°ú Join
                const nickname = `User_${sessionWallet.address.slice(-4)}`;
                myAddress = sessionWallet.address; // ÏÑ∏ÏÖò Ï£ºÏÜåÎ°ú Î≥ÄÍ≤Ω

                log(`Joining as "${nickname}"...`, 'info');
                joinBtn.innerHTML = '<span class="spinner"></span> Joining...';

                const tx = await sessionContract.join(nickname);
                log(`Join TX: ${tx.hash.slice(0, 10)}...`, 'tx');

                await tx.wait();

                isJoined = true;
                stats.txSent++;

                log(`‚úÖ Joined! Auto-sign enabled`, 'tx');

                myAddressEl.textContent = `${myAddress.slice(0, 6)}...${myAddress.slice(-4)} (session)`;
                createCursor(myAddress, nickname);

                // Í∏∞Ï°¥ Ïú†Ï†Ä Î°úÎìú
                await loadExistingUsers();

                // Ïù¥Î≤§Ìä∏ Ìè¥ÎßÅ ÏãúÏûë
                startEventPolling();

                // ÎßàÏö∞Ïä§ Ìä∏ÎûòÌÇπ ÏãúÏûë
                startMouseTracking();

                joinBtn.textContent = '‚úÖ Joined (Auto-sign)';
                updateStats();

            } catch (error) {
                log(`Join error: ${error.message}`, 'error');
                joinBtn.disabled = false;
                joinBtn.textContent = '‚ú® Join Room';
            }
        }
        
        // ===== Í∏∞Ï°¥ Ïú†Ï†Ä Î°úÎìú =====
        async function loadExistingUsers() {
            try {
                const users = await contract.getActiveUsers();
                log(`Found ${users.length} active users`, 'info');
                
                for (const user of users) {
                    if (user.toLowerCase() !== myAddress.toLowerCase()) {
                        const info = await contract.getUserInfo(user);
                        if (info[3]) { // isActive
                            createCursor(user, info[0] || `User_${user.slice(-4)}`);
                            updateCursor(user, info[1], info[2]);
                        }
                    }
                }
            } catch (error) {
                log(`Error loading users: ${error.message}`, 'error');
            }
        }
        
        // ===== Ïù¥Î≤§Ìä∏ Ìè¥ÎßÅ (WebSocket ÎåÄÏ≤¥) =====
        function startEventPolling() {
            let lastBlock = 0;
            
            // CursorMoved Ïù¥Î≤§Ìä∏ ÌïÑÌÑ∞
            const cursorFilter = contract.filters.CursorMoved();
            const joinFilter = contract.filters.UserJoined();
            const leaveFilter = contract.filters.UserLeft();
            
            pollTimer = setInterval(async () => {
                try {
                    const currentBlock = await provider.getBlockNumber();
                    if (lastBlock === 0) lastBlock = currentBlock - 1;
                    
                    if (currentBlock > lastBlock) {
                        // CursorMoved Ïù¥Î≤§Ìä∏
                        const cursorEvents = await contract.queryFilter(cursorFilter, lastBlock + 1, currentBlock);
                        for (const event of cursorEvents) {
                            const { user, x, y, timestamp } = event.args;
                            
                            stats.eventsReceived++;
                            
                            // ÏßÄÏó∞ÏãúÍ∞Ñ Í≥ÑÏÇ∞
                            if (user.toLowerCase() === myAddress.toLowerCase()) {
                                const now = Date.now();
                                const latency = now - stats.lastTxTime;
                                if (latency > 0 && latency < 5000) {
                                    stats.latencies.push(latency);
                                }
                            }
                            
                            updateCursor(user, x, y);
                        }
                        
                        // UserJoined Ïù¥Î≤§Ìä∏
                        const joinEvents = await contract.queryFilter(joinFilter, lastBlock + 1, currentBlock);
                        for (const event of joinEvents) {
                            const { user, nickname } = event.args;
                            if (user.toLowerCase() !== myAddress.toLowerCase()) {
                                log(`User joined: ${nickname}`, 'event');
                                createCursor(user, nickname);
                            }
                        }
                        
                        // UserLeft Ïù¥Î≤§Ìä∏
                        const leaveEvents = await contract.queryFilter(leaveFilter, lastBlock + 1, currentBlock);
                        for (const event of leaveEvents) {
                            const { user } = event.args;
                            log(`User left: ${user.slice(0, 8)}...`, 'event');
                            removeCursor(user);
                        }
                        
                        lastBlock = currentBlock;
                        updateStats();
                    }
                } catch (error) {
                    // Ìè¥ÎßÅ ÏóêÎü¨Îäî Ï°∞Ïö©Ìûà Î¨¥Ïãú
                }
            }, 500); // 500ms Ìè¥ÎßÅ
        }
        
        // ===== ÎßàÏö∞Ïä§ Ìä∏ÎûòÌÇπ =====
        function startMouseTracking() {
            document.addEventListener('mousemove', (e) => {
                const x = Math.floor((e.clientX / window.innerWidth) * 65535);
                const y = Math.floor((e.clientY / window.innerHeight) * 65535);
                
                pendingPosition = { x, y };
                myPositionEl.textContent = `${e.clientX}, ${e.clientY}`;
                
                // Î°úÏª¨ Ïª§ÏÑú Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                updateCursor(myAddress, x, y);
            });
            
            // ÏùºÏ†ï Í∞ÑÍ≤©ÏúºÎ°ú TX Ï†ÑÏÜ°
            updateTimer = setInterval(sendPositionUpdate, CONFIG.updateInterval);
            log(`Mouse tracking started (${CONFIG.updateInterval}ms interval)`, 'info');
        }
        
        async function sendPositionUpdate() {
            if (!isJoined || !pendingPosition || !sessionContract) return;
            if (pendingPosition.x === lastSentPosition.x && pendingPosition.y === lastSentPosition.y) return;

            const { x, y } = pendingPosition;
            lastSentPosition = { x, y };

            try {
                stats.lastTxTime = Date.now();

                // ÏÑ∏ÏÖò ÏõîÎ†õÏúºÎ°ú ÏûêÎèô ÏÑúÎ™Ö (MetaMask Ïª®Ìéå ÏóÜÏùå!)
                sessionContract.moveCursor(x, y, { gasLimit: 100000 }).then(tx => {
                    stats.txSent++;
                    updateStats();
                }).catch(err => {
                    // ÏùºÎ∂Ä TX Ïã§Ìå®Îäî Î¨¥Ïãú
                });
            } catch (error) {
                // Î¨¥Ïãú
            }
        }
        
        // ===== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà =====
        connectBtn.addEventListener('click', connectWallet);
        
        deployBtn.addEventListener('click', () => {
            contractModal.classList.add('active');
        });
        
        document.getElementById('deploy-new-btn').addEventListener('click', () => {
            contractModal.classList.remove('active');
            deployContract();
        });
        
        document.getElementById('use-existing-btn').addEventListener('click', () => {
            const address = contractInput.value.trim();
            if (address && ethers.utils.isAddress(address)) {
                useExistingContract(address);
            } else {
                alert('Ïò¨Î∞îÎ•∏ Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
            }
        });
        
        joinBtn.addEventListener('click', joinSession);
        
        // ÌéòÏù¥ÏßÄ ÎÇòÍ∞à Îïå Ï†ïÎ¶¨
        window.addEventListener('beforeunload', async () => {
            if (updateTimer) clearInterval(updateTimer);
            if (pollTimer) clearInterval(pollTimer);
            
            if (isJoined && contract) {
                try {
                    await contract.leave({ gasLimit: 100000 });
                } catch (e) {}
            }
        });
        
        // ESCÎ°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                contractModal.classList.remove('active');
            }
        });
        
        // ===== Ï¥àÍ∏∞Ìôî =====
        log('üñ±Ô∏è Onchain Mouse Tracker loaded', 'info');
        log(`Network: ${CONFIG.chainName} (Chain ID: ${CONFIG.chainId})`, 'info');
        log(`RPC: ${CONFIG.rpcUrl}`, 'info');
        log('Click "Connect Wallet" to start!', 'info');
    </script>
</body>
</html>
